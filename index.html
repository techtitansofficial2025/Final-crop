<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>किसान मित्र - Crop Predictor</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root{
    --bg1:#667eea; --bg2:#764ba2;
    --card-shadow:0 12px 30px rgba(0,0,0,0.09);
    --muted:#666;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter, "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; min-height:100vh;
       padding:18px; background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%); color:#1f2d3d;}
  .container{max-width:1200px;margin:0 auto}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;color:white; margin-bottom:18px}
  .brand{font-weight:800}
  .lang-toggle{background:rgba(255,255,255,0.12);padding:8px 12px;border-radius:20px;border:1px solid rgba(255,255,255,0.18);cursor:pointer;color:white;display:inline-flex;align-items:center;gap:8px}
  /* pages */
  .page{display:none}
  .page.active{display:block}
  /* input center card */
  .center-card{max-width:820px;margin:18px auto;background:linear-gradient(145deg,#fff,#f7f9ff);padding:24px;border-radius:14px;box-shadow:var(--card-shadow)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){ .grid-2{grid-template-columns:1fr} }
  label{display:block;font-weight:700;margin-bottom:6px;color:#283344}
  .form-control{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6eaf6;background:white}
  .radio-row{display:flex;gap:12px;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:linear-gradient(45deg,#ff6b6b,#ee5a24);color:white}
  .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
  .note{font-size:0.9rem;color:var(--muted);margin-top:6px}

  /* output layout */
  .output-wrap{display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media(max-width:980px){ .output-wrap{grid-template-columns:1fr} }
  .left-panel{background:linear-gradient(180deg,#fff,#fbfdff);padding:14px;border-radius:12px;box-shadow:var(--card-shadow)}
  .right-panel{background:linear-gradient(180deg,#fff,#fbfdff);padding:14px;border-radius:12px;box-shadow:var(--card-shadow)}
  .crop-list{display:flex;flex-direction:column;gap:8px}
  .crop-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;border:1px solid #eef2fb;background:#fff;cursor:pointer}
  .crop-row .left{display:flex;gap:8px;align-items:center}
  .crop-row .chev{transition:transform .18s ease}
  .expanded-panel{overflow:hidden;transition:max-height .28s ease,opacity .22s ease;padding:8px 10px;margin-top:8px;border-radius:8px;background:#fbfdff;border:1px solid #eef4ff}
  .expanded-panel.hidden{max-height:0;opacity:0;padding-top:0;padding-bottom:0}
  .expanded-panel.visible{max-height:800px;opacity:1}
  .card-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media(max-width:900px){ .card-grid{grid-template-columns:repeat(2,1fr)} }
  @media(max-width:520px){ .card-grid{grid-template-columns:1fr} }
  /* input-status card (right column) */
  .input-card{background:white;border-radius:10px;padding:12px;border-left:6px solid #e9eefb;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
  .input-card h4{margin-bottom:8px;font-size:0.98rem;display:flex;align-items:center;gap:8px}
  .gauge-wrap{display:flex;align-items:center;gap:12px}
  .gauge-svg{width:120px;height:120px;flex-shrink:0}
  .gauge-meta{text-align:left}
  .status-label{font-weight:800;margin-top:6px}
  .status-good{color:#2e7d32} /* green */
  .status-caution{color:#f57c00} /* orange */
  .status-bad{color:#c62828} /* red */
  .status-missing{color:#6d6d6d} /* gray */

  /* radial gauge segments: we render using SVG arcs; needle is rotated */
  /* small helpers */
  .muted{color:var(--muted);font-size:0.92rem}
  .back-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .back-btn{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px 12px;border-radius:8px;cursor:pointer}
  .small{font-size:0.92rem;color:var(--muted)}

  /* animations */
  .fade-in{animation:fadeIn .28s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

  /* Expand arrow rotation when active */
  .chev-open{transform:rotate(180deg)}

  /* accessibility focus */
  button:focus, .crop-row:focus{outline:3px solid rgba(102,126,234,0.14);outline-offset:2px}
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div style="display:flex;gap:14px;align-items:center">
        <div class="brand"><i class="fas fa-seedling"></i> <span id="brandTitle">किसान मित्र</span></div>
        <div class="small" id="subtitleText">Your smart crop advisor</div>
      </div>
      <div>
        <button id="langToggleTop" class="lang-toggle" aria-pressed="false"><i class="fas fa-language"></i> <span id="langLabelTop">हिंदी</span></button>
      </div>
    </div>

    <!-- INPUT PAGE -->
    <div id="pageInput" class="page active" aria-hidden="false">
      <div class="center-card" role="region" aria-label="Input">
        <h2 style="text-align:center;margin-bottom:12px"><i class="fas fa-edit"></i> <span id="inputHeading">Enter crop details</span></h2>

        <form id="mainForm" onsubmit="return false;">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
            <div class="radio-row" style="gap:10px">
              <label><input type="radio" name="sowNow" value="now" checked> <span id="sowNowLabel">Sow now</span></label>
              <label><input type="radio" name="sowNow" value="later"> <span id="sowLaterLabel">Sow later</span></label>
            </div>
            <div style="margin-left:auto" class="small" id="sowNote">Auto-fills weather for "Sow now"</div>
          </div>

          <div class="grid-2" style="gap:12px">
            <div>
              <label id="soilLabel">Soil type</label>
              <select id="soil" class="form-control" required>
                <option value="" disabled selected>Select soil</option>
                <option value="alluvial">Alluvial</option>
                <option value="loamy">Loamy</option>
                <option value="clay">Clay</option>
                <option value="sandy">Sandy</option>
                <option value="black">Black</option>
                <option value="red">Red</option>
              </select>
            </div>

            <div id="seasonWrap">
              <label id="seasonLabel">Sowing season</label>
              <select id="sown" class="form-control">
                <option value="" disabled selected>Select season</option>
                <option value="kharif">Kharif</option>
                <option value="rabi">Rabi</option>
                <option value="zaid">Zaid</option>
              </select>
            </div>

            <div>
              <label id="phLabel">Soil pH</label>
              <input id="soil_ph" class="form-control" type="number" step="any" placeholder="e.g. 6.8" required>
            </div>

            <div id="tempWrap">
              <label id="tempLabel">Temperature (°C)</label>
              <input id="temp" class="form-control" type="number" step="any" placeholder="e.g. 26" >
            </div>

            <div id="humidityWrap">
              <label id="humidityLabel">Humidity (%)</label>
              <input id="humidity" class="form-control" type="number" step="any" placeholder="e.g. 60" >
            </div>

            <div>
              <label id="locationLabel">Auto location (only for "Sow now")</label>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="useLocationBtn" class="btn btn-ghost" type="button"><i class="fas fa-map-marker-alt"></i> <span id="locBtnText">Use my location</span></button>
                <div class="small" id="locNote">Only for "Sow now"</div>
              </div>
            </div>

            <div>
              <label id="nitrogenLabel">Nitrogen (N) kg/ha</label>
              <input id="nitrogen" class="form-control" type="number" step="any" placeholder="e.g. 50" required>
            </div>

            <div>
              <label id="phosphorusLabel">Phosphorus (P) kg/ha</label>
              <input id="phosphorus" class="form-control" type="number" step="any" placeholder="e.g. 25" required>
            </div>

            <div>
              <label id="potassiumLabel">Potassium (K) kg/ha</label>
              <input id="potassium" class="form-control" type="number" step="any" placeholder="e.g. 30" required>
            </div>
          </div>

          <div style="margin-top:14px;display:flex;gap:10px;justify-content:center">
            <button id="predictBtn" class="btn btn-primary" type="button"><i class="fas fa-magic"></i> <span id="predictText">Predict</span></button>
            <button id="resetBtn" class="btn btn-ghost" type="button"><i class="fas fa-eraser"></i> Reset</button>
          </div>
        </form>
      </div>
    </div>

    <!-- OUTPUT PAGE -->
    <div id="pageOutput" class="page" aria-hidden="true">
      <div class="back-row">
        <div>
          <button id="backBtn" class="back-btn"><i class="fas fa-arrow-left"></i> <span id="backText">Back</span></button>
        </div>
        <div>
          <button id="langToggleBottom" class="lang-toggle"><i class="fas fa-language"></i> <span id="langLabelBottom">हिंदी</span></button>
        </div>
      </div>

      <div class="output-wrap">
        <div class="left-panel" aria-label="Recommended crops">
          <h3 id="recommendedTitle">Recommended crops</h3>
          <div id="cropList" class="crop-list" role="list">
            <!-- items populated via JS -->
          </div>
        </div>

        <div class="right-panel" aria-label="Input statuses">
          <h3 id="detailsTitle">Input statuses</h3>
          <div style="margin-top:10px" class="card-grid" id="statusCards">
            <!-- six input-status cards (Nitrogen, Phosphorus, Potassium, pH, Temp, Humidity) -->
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
/* --------------------------
   Localization strings & helpers
   -------------------------- */
let currentLang = 'hi';
const T = {
  hi: {
    langLabel:'English', brand:'किसान मित्र', subtitle:'आपका स्मार्ट कृषि सलाहकार',
    inputHeading:'फसल की जानकारी दें', sowNow:'अब बोएं', sowLater:'बाद में बोएं', sowNote:'अब बोने पर मौसम स्वतः भरा जाएगा',
    soil:'मिट्टी प्रकार', season:'बुवाई का मौसम', ph:'मिट्टी का pH', temp:'तापमान (°C)', humidity:'आर्द्रता (%)',
    autoLoc:'स्थान से भरें (केवल अब)', nitrogen:'नाइट्रोजन (N)', phosphorus:'फास्फोरस (P)', potassium:'पोटैशियम (K)',
    predict:'भविष्यवाणी करें', reset:'रीसेट', back:'वापस', recommended:'सुझावित फसलें', details:'इनपुट स्थिति',
    status_good:'अच्छा', status_caution:'सावधानी', status_bad:'खराब', status_missing:'नहीं दिया',
    helper_good:'फसल के लिए अच्छा', helper_caution:'ध्यान दें', helper_bad:'ठीक नहीं', helper_missing:'कृपया भरें',
    meterLabel:'उपयुक्तता', locRequesting:'अनुरोध...'
  },
  en: {
    langLabel:'हिंदी', brand:'Farmer Friend', subtitle:'Your smart crop advisor',
    inputHeading:'Enter crop details', sowNow:'Sow now', sowLater:'Sow later', sowNote:'Auto-fills weather for "Sow now"',
    soil:'Soil type', season:'Sowing season', ph:'Soil pH', temp:'Temperature (°C)', humidity:'Humidity (%)',
    autoLoc:'Use location (now only)', nitrogen:'Nitrogen (N)', phosphorus:'Phosphorus (P)', potassium:'Potassium (K)',
    predict:'Predict', reset:'Reset', back:'Back', recommended:'Recommended crops', details:'Input statuses',
    status_good:'Good', status_caution:'Caution', status_bad:'High', status_missing:'Not provided',
    helper_good:'Good for crop', helper_caution:'Needs attention', helper_bad:'Not suitable', helper_missing:'Please fill',
    meterLabel:'Suitability', locRequesting:'Requesting...'
  }
};
function t(key){ return (T[currentLang] && T[currentLang][key]) ? T[currentLang][key] : key; }

/* Update UI language text */
function setLang(lang){
  currentLang = lang;
  document.getElementById('langLabelTop').textContent = t('langLabel');
  document.getElementById('langLabelBottom').textContent = t('langLabel');
  document.getElementById('brandTitle').textContent = t('brand');
  document.getElementById('subtitleText').textContent = t('subtitle');
  document.getElementById('inputHeading').textContent = t('inputHeading');
  document.getElementById('sowNowLabel').textContent = t('sowNow');
  document.getElementById('sowLaterLabel').textContent = t('sowLater');
  document.getElementById('sowNote').textContent = t('sowNote');
  document.getElementById('soilLabel').textContent = t('soil');
  document.getElementById('seasonLabel').textContent = t('season');
  document.getElementById('phLabel').textContent = t('ph');
  document.getElementById('tempLabel').textContent = t('temp');
  document.getElementById('humidityLabel').textContent = t('humidity');
  document.getElementById('locationLabel').textContent = t('autoLoc');
  document.getElementById('nitrogenLabel').textContent = t('nitrogen') + ' (kg/ha)';
  document.getElementById('phosphorusLabel').textContent = t('phosphorus') + ' (kg/ha)';
  document.getElementById('potassiumLabel').textContent = t('potassium') + ' (kg/ha)';
  document.getElementById('predictText').textContent = t('predict');
  document.getElementById('resetBtn').textContent = t('reset');
  document.getElementById('backText').textContent = t('back');
  document.getElementById('recommendedTitle').textContent = t('recommended');
  document.getElementById('detailsTitle').textContent = t('details');
}
setLang(currentLang);

/* wire language toggles */
document.getElementById('langToggleTop').addEventListener('click', ()=>{
  setLang(currentLang==='hi'?'en':'hi');
  document.getElementById('langToggleTop').setAttribute('aria-pressed', currentLang==='en');
  document.getElementById('langToggleBottom').setAttribute('aria-pressed', currentLang==='en');
  // refresh output if visible
  if(document.getElementById('pageOutput').classList.contains('active')) {
    renderOutput(window._lastPredictions || simulateMLPrediction(window._lastForm || {}), window._lastForm || {});
  }
});
document.getElementById('langToggleBottom').addEventListener('click', ()=>{
  setLang(currentLang==='hi'?'en':'hi');
  document.getElementById('langToggleTop').setAttribute('aria-pressed', currentLang==='en');
  document.getElementById('langToggleBottom').setAttribute('aria-pressed', currentLang==='en');
  if(document.getElementById('pageOutput').classList.contains('active')) {
    renderOutput(window._lastPredictions || simulateMLPrediction(window._lastForm || {}), window._lastForm || {});
  }
});

/* ---------------------------
   Form logic: show/hide season/temp/humidity
   --------------------------- */
function updateSowUI(){
  const val = document.querySelector('input[name="sowNow"]:checked').value;
  const seasonWrap = document.getElementById('seasonWrap');
  const tempWrap = document.getElementById('tempWrap');
  const humidityWrap = document.getElementById('humidityWrap');
  const useLocationBtn = document.getElementById('useLocationBtn');
  if(val === 'now'){ seasonWrap.style.display=''; tempWrap.style.display=''; humidityWrap.style.display=''; useLocationBtn.disabled=false; document.getElementById('locNote').textContent = t('sowNote'); }
  else { seasonWrap.style.display='none'; tempWrap.style.display='none'; humidityWrap.style.display='none'; useLocationBtn.disabled=true; document.getElementById('locNote').textContent = t('autoLoc') + ' - Off'; }
}
Array.from(document.querySelectorAll('input[name="sowNow"]')).forEach(r=> r.addEventListener('change', updateSowUI));
updateSowUI();

/* ---------------------------
   Prediction simulation & heuristics
   --------------------------- */
function simulateMLPrediction(formData){
  const soil = (formData.soil||'').toLowerCase();
  let list = [];
  if(soil.includes('black')) list = ['Cotton','Chickpea','Pearl millet'];
  else if(soil.includes('alluvial') || soil.includes('loamy')) list = ['Rice','Wheat','Maize'];
  else if(soil.includes('sandy')) list = ['Maize','Sunflower','Cucumber'];
  else if(soil.includes('red')) list = ['Pulses','Sorghum','Millet'];
  else list = ['Maize','Wheat','Rice'];
  if(formData.sown){
    if(formData.sown === 'kharif') list.sort((a)=> a==='Rice' ? -1 : 1);
    if(formData.sown === 'rabi') list.sort((a)=> a==='Wheat' ? -1 : 1);
    if(formData.sown === 'zaid') list.sort((a)=> a==='Maize' ? -1 : 1);
  }
  const toObj = name => ({ crop:name, water_source: name.toLowerCase().includes('rice') ? 'River/Rain' : (name.toLowerCase().includes('cotton') ? 'Rain' : 'Tube well / Drip'), duration: name.toLowerCase().includes('rice') ? '120 days' : '90-120 days', water_required: name.toLowerCase().includes('rice') ? '1200 L/kg' : '500-900 L/kg' });
  return { primary: toObj(list[0]), alternatives: list.map(toObj) };
}

/* ---------------------------
   NPK and status helpers
   --------------------------- */
function getIdealNPK(cropName){ const name=(cropName||'').toLowerCase(); const defaultRange = {N:{min:20,max:80},P:{min:10,max:40},K:{min:20,max:80}}; if(name.includes('rice')) return {N:{min:60,max:140},P:{min:20,max:60},K:{min:40,max:120}}; if(name.includes('wheat')) return {N:{min:80,max:160},P:{min:30,max:70},K:{min:30,max:80}}; if(name.includes('maize')) return {N:{min:80,max:200},P:{min:30,max:80},K:{min:40,max:120}}; if(name.includes('cotton')) return {N:{min:60,max:120},P:{min:30,max:60},K:{min:40,max:120}}; return defaultRange; }
function statusForNPK(value, ideal){ if(!Number.isFinite(value)) return 'missing'; if(value < ideal.min) return 'low'; if(value > ideal.max) return 'high'; return 'near'; }
function statusForPH(v){ if(!Number.isFinite(v)) return 'missing'; if(v < 4.5 || v > 9) return 'bad'; if(v < 6.5 || v > 7.5) return 'caution'; return 'good'; }
function statusForTemp(v){ if(!Number.isFinite(v)) return 'missing'; if(v < -10 || v > 50) return 'bad'; if(v < 5 || v > 40) return 'caution'; return 'good'; }
function statusForHumidity(v){ if(!Number.isFinite(v)) return 'missing'; if(v < 0 || v > 100) return 'bad'; if(v < 30 || v > 80) return 'caution'; return 'good'; }

/* mapping visual text + color classes */
function statusTextAndClass(kind, status){
  // kind indicates nitro/phos/...
  if(status === 'missing') return {text: t('status_missing'), cls: 'status-missing'};
  if(kind === 'npk'){
    if(status === 'low') return {text: currentLang==='hi' ? 'कम' : 'Low', cls:'status-bad'};
    if(status === 'near') return {text: currentLang==='hi' ? 'नज़दीक' : 'Near ideal', cls:'status-good'};
    if(status === 'high') return {text: currentLang==='hi' ? 'ऊंचा' : 'High', cls:'status-bad'}; // you asked high in red
  } else {
    if(status === 'good') return {text:t('status_good'), cls:'status-good'};
    if(status === 'caution') return {text:t('status_caution'), cls:'status-caution'};
    if(status === 'bad') return {text:t('status_bad'), cls:'status-bad'};
  }
  return {text:t('status_missing'), cls:'status-missing'};
}

/* gauge converter: convert actual value to 0..100 based on ideal ranges */
function npkValueToPercent(value, idealRange){
  if(!Number.isFinite(value)) return 0;
  // map 0..(ideal.min) => 0..40, ideal range => 40..70, above ideal to max => 70..100
  if(value <= idealRange.min) { return Math.round((value / Math.max(1, idealRange.min)) * 40); }
  if(value <= idealRange.max) {
    const ratio = (value - idealRange.min) / (idealRange.max - idealRange.min);
    return Math.round(40 + ratio * 30); // 40..70
  }
  // above ideal
  const aboveRatio = (value - idealRange.max) / Math.max(1, idealRange.max);
  return Math.min(100, Math.round(70 + Math.min(30, aboveRatio * 30)));
}
function phToPercent(v){ if(!Number.isFinite(v)) return 0; const clamped = Math.max(3, Math.min(9, v)); return Math.round(((clamped - 3) / (9 - 3)) * 100); }
function tempToPercent(v){ if(!Number.isFinite(v)) return 0; const clamped = Math.max(-10, Math.min(50, v)); return Math.round(((clamped + 10) / 60) * 100); }
function humidityToPercent(v){ if(!Number.isFinite(v)) return 0; const clamped = Math.max(0, Math.min(100, v)); return Math.round(clamped); }

/* ---------------------------
   Radial gauge renderer (SVG) - G3
   - colored segments (red/orange/green) and a needle
   - function returns an <svg> string with needle rotated for percentage
   --------------------------- */
function makeRadialGaugeSVG(percent, size=120){
  // percent: 0..100, we map to arc -120deg .. +120deg (240deg sweep)
  const cx = size/2, cy = size/2, r = (size/2) - 12;
  const startAngle = -120 * Math.PI/180;
  const endAngle = 120 * Math.PI/180;
  // helpers
  function polar(a, rad){ return { x: cx + rad * Math.cos(a), y: cy + rad * Math.sin(a) }; }
  // colored segments thresholds: 0-35 red, 35-65 orange, 65-100 green
  const segs = [
    {from:0,to:35, color:'#f44336'},
    {from:35,to:65, color:'#ff9800'},
    {from:65,to:100,color:'#4caf50'}
  ];
  const segPaths = segs.map(seg=>{
    const a1 = startAngle + ( (endAngle - startAngle) * (seg.from/100) );
    const a2 = startAngle + ( (endAngle - startAngle) * (seg.to/100) );
    const p1 = polar(a1, r);
    const p2 = polar(a2, r);
    const large = (Math.abs(a2-a1) > Math.PI) ? 1 : 0;
    return `<path d="M ${p1.x} ${p1.y} A ${r} ${r} 0 ${large} 1 ${p2.x} ${p2.y}" fill="none" stroke="${seg.color}" stroke-width="10" stroke-linecap="round" />`;
  }).join('');
  // needle angle
  const angle = startAngle + ( (endAngle - startAngle) * (percent / 100) );
  const needleOuter = polar(angle, r - 6);
  const needleInner = polar(angle + Math.PI, 10); // small tail
  // center circle color based on percent
  let centerColor = '#c62828';
  if(percent >= 65) centerColor = '#2e7d32';
  else if(percent >= 35) centerColor = '#f57c00';
  // assemble
  const svg = `
    <svg class="gauge-svg" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="gauge">
      <defs>
        <filter id="s" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.08"/></filter>
      </defs>
      <g filter="url(#s)">
        ${segPaths}
        <line x1="${cx}" y1="${cy}" x2="${needleOuter.x}" y2="${needleOuter.y}" stroke="${centerColor}" stroke-width="3.5" stroke-linecap="round" />
        <circle cx="${cx}" cy="${cy}" r="6" fill="${centerColor}" stroke="#fff" stroke-width="1.4" />
      </g>
      <text x="${cx}" y="${cy + r*0.6}" text-anchor="middle" font-size="${size*0.12}" fill="#111" font-weight="700">${percent}%</text>
    </svg>
  `;
  return svg;
}

/* ---------------------------
   Build the six right-side status cards
   --------------------------- */
function renderStatusCards(formData, cropName){
  const container = document.getElementById('statusCards');
  container.innerHTML = '';
  const ideal = getIdealNPK(cropName || '');
  // prepare values
  const vals = [
    { id:'nitrogen', label: t('nitrogen'), type:'npk', raw: formData.nitrogen, percent: npkValueToPercent(formData.nitrogen, ideal.N), status: statusForNPK(formData.nitrogen, ideal.N) },
    { id:'phosphorus', label: t('phosphorus'), type:'npk', raw: formData.phosphorus, percent: npkValueToPercent(formData.phosphorus, ideal.P), status: statusForNPK(formData.phosphorus, ideal.P) },
    { id:'potassium', label: t('potassium'), type:'npk', raw: formData.potassium, percent: npkValueToPercent(formData.potassium, ideal.K), status: statusForNPK(formData.potassium, ideal.K) },
    { id:'soil_ph', label: 'pH', type:'ph', raw: formData.soil_ph, percent: phToPercent(formData.soil_ph), status: statusForPH(formData.soil_ph) },
    { id:'temp', label: t('temp'), type:'temp', raw: formData.temp, percent: tempToPercent(formData.temp), status: statusForTemp(formData.temp) },
    { id:'humidity', label: t('humidity'), type:'hum', raw: formData.humidity, percent: humidityToPercent(formData.humidity), status: statusForHumidity(formData.humidity) }
  ];
  // arrange 3x2
  vals.forEach(v=>{
    const div = document.createElement('div');
    div.className = 'input-card fade-in';
    const s = statusTextAndClass(v.type==='npk'?'npk':'misc', v.status === 'near' ? 'near' : (v.status==='low' ? 'low' : (v.status==='high'?'high': v.status)));
    // For npk mapping: 'near' -> green; 'low'/'high' -> red
    let statusText = s.text, statusCls = s.cls;
    // If mapping returned near/low/high handled above, adjust text for hi/ en
    if(v.type === 'npk'){
      if(v.status === 'near') { statusText = currentLang==='hi' ? 'नज़दीक' : 'Near ideal'; statusCls = 'status-good'; }
      if(v.status === 'low') { statusText = currentLang==='hi' ? 'कम' : 'Low'; statusCls = 'status-bad'; }
      if(v.status === 'high') { statusText = currentLang==='hi' ? 'ऊंचा' : 'High'; statusCls = 'status-bad'; }
      if(v.status === 'missing') { statusText = t('status_missing'); statusCls = 'status-missing'; }
    } else {
      // ph / temp / humidity maps
      if(v.status === 'good') { statusText = t('status_good'); statusCls = 'status-good'; }
      if(v.status === 'caution') { statusText = t('status_caution'); statusCls = 'status-caution'; }
      if(v.status === 'bad') { statusText = t('status_bad'); statusCls = 'status-bad'; }
      if(v.status === 'missing') { statusText = t('status_missing'); statusCls = 'status-missing'; }
    }

    div.innerHTML = `
      <h4>${v.label}</h4>
      <div class="gauge-wrap">
        <div>${makeRadialGaugeSVG(v.percent, 120)}</div>
        <div class="gauge-meta">
          <div class="muted">${v.raw !== undefined && Number.isFinite(v.raw) ? (v.raw + (v.id==='soil_ph'? '':'') ) : ''}</div>
          <div class="status-label ${statusCls}">${statusText}</div>
        </div>
      </div>
    `;
    container.appendChild(div);
  });
}

/* ---------------------------
   Render crop list (left) with expand/collapse per crop
   - multiple expansions allowed
   - expanded content: details + buildInputSummary for that crop
   --------------------------- */
function buildInputSummaryHtml(formData, cropName){
  const ideal = getIdealNPK(cropName || '');
  const nKey = statusForNPK(formData.nitrogen, ideal.N);
  const pKey = statusForNPK(formData.phosphorus, ideal.P);
  const kKey = statusForNPK(formData.potassium, ideal.K);
  const phKey = statusForPH(formData.soil_ph);
  const tKey = statusForTemp(formData.temp);
  const hKey = statusForHumidity(formData.humidity);
  const rows = [
    {id:'N', label: currentLang==='hi' ? 'नाइट्रोजन (N)' : 'Nitrogen (N)', status:nKey, raw: Number.isFinite(formData.nitrogen)? formData.nitrogen+' kg/ha':''},
    {id:'P', label: currentLang==='hi' ? 'फास्फोरस (P)' : 'Phosphorus (P)', status:pKey, raw: Number.isFinite(formData.phosphorus)? formData.phosphorus+' kg/ha':''},
    {id:'K', label: currentLang==='hi' ? 'पोटैशियम (K)' : 'Potassium (K)', status:kKey, raw: Number.isFinite(formData.potassium)? formData.potassium+' kg/ha':''},
    {id:'pH', label: 'pH', status:phKey, raw: Number.isFinite(formData.soil_ph)? 'pH '+formData.soil_ph:''},
    {id:'Temp', label: currentLang==='hi' ? 'तापमान' : 'Temp', status:tKey, raw: Number.isFinite(formData.temp)? formData.temp+'°C':''},
    {id:'Humidity', label: currentLang==='hi' ? 'आर्द्रता' : 'Humidity', status:hKey, raw: Number.isFinite(formData.humidity)? formData.humidity+'%':''}
  ];
  let html = '';
  rows.forEach(r=>{
    let badge = {emoji:'ℹ️', text:t('status_missing'), cls:'status-missing', helper: t('helper_missing')};
    if(r.status === 'low'){ badge = {emoji:'❌', text: currentLang==='hi'?'कम':'Low', cls:'status-bad', helper:t('helper_bad')}; }
    if(r.status === 'near' || r.status === 'good'){ badge = {emoji:'✅', text: currentLang==='hi'?'अच्छा':'Good', cls:'status-good', helper:t('helper_good')}; }
    if(r.status === 'high'){ badge = {emoji:'❌', text: currentLang==='hi'?'ऊंचा':'High', cls:'status-bad', helper:t('helper_bad')}; }
    if(r.status === 'caution'){ badge = {emoji:'⚠️', text: currentLang==='hi'?'सावधानी':'Caution', cls:'status-caution', helper:t('helper_caution')}; }
    html += `
      <div style="display:flex;gap:10px;align-items:center;padding:6px 0;border-bottom:1px dashed rgba(0,0,0,0.04)">
        <div style="width:36px;text-align:center;font-size:18px">${badge.emoji}</div>
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="font-weight:700">${r.label}${r.raw? ' — '+r.raw : ''}</div>
            <div style="margin-left:auto" class="${badge.cls}" style="font-weight:800">${badge.text}</div>
          </div>
          <div style="color:#333;opacity:0.9;font-size:0.92rem;margin-top:4px">${badge.helper}</div>
        </div>
      </div>
    `;
  });
  return html;
}

function renderOutput(predictions, formData){
  // store last
  window._lastPredictions = predictions;
  window._lastForm = formData;
  // collapse any expanded panels (per requirement #5 - collapse and update)
  // We'll clear the cropList and re-render fresh (no panels open)
  const cropList = document.getElementById('cropList');
  cropList.innerHTML = '';
  const arr = predictions.alternatives.slice(0,6);
  arr.forEach((p, idx)=>{
    const row = document.createElement('div');
    row.className = 'crop-row';
    row.tabIndex = 0;
    row.setAttribute('role','button');
    const cropId = 'crop_' + idx;
    row.innerHTML = `
      <div class="left"><strong>${p.crop}</strong><div class="muted" style="font-size:0.85rem;margin-left:8px">${p.duration}</div></div>
      <div style="display:flex;align-items:center;gap:8px">
        <button class="btn btn-ghost" aria-expanded="false" data-index="${idx}" title="Show details"><i class="fas fa-chevron-down chev" data-index="${idx}"></i></button>
      </div>
    `;
    // below the row add an expandable container (initially hidden)
    const panel = document.createElement('div');
    panel.className = 'expanded-panel hidden';
    panel.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap">
        <div style="flex:1;min-width:200px">
          <div style="font-weight:800;margin-bottom:6px">${p.crop}</div>
          <div class="small">${p.water_source} · ${p.duration} · ${p.water_required}</div>
        </div>
        <div style="min-width:220px;flex-basis:220px">
          <!-- summary goes here -->
          <div id="${cropId}_summary"></div>
        </div>
      </div>
    `;
    // add handlers: expand button toggles panel (multiple allowed)
    row.querySelector('button').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const expanded = row.querySelector('button').getAttribute('aria-expanded') === 'true';
      // toggle without collapsing other panels (user wanted multiple)
      row.querySelector('button').setAttribute('aria-expanded', String(!expanded));
      const chev = row.querySelector('.chev');
      if(!expanded){ chev.classList.add('chev-open'); panel.classList.remove('hidden'); panel.classList.add('visible'); }
      else { chev.classList.remove('chev-open'); panel.classList.remove('visible'); panel.classList.add('hidden'); }
      // fill summary on open
      if(!expanded){
        const summ = document.getElementById(cropId + '_summary');
        summ.innerHTML = buildInputSummaryHtml(formData, p.crop);
        // scroll into view a bit
        panel.scrollIntoView({behavior:'smooth', block:'nearest'});
      }
    });
    // also allow clicking row to expand
    row.addEventListener('click', ()=>{
      const btn = row.querySelector('button'); btn.click();
    });

    cropList.appendChild(row);
    cropList.appendChild(panel);
  });

  // right side: six status cards (3x2)
  renderStatusCards(formData, predictions.primary.crop);
}

/* ---------------------------
   Navigation: Predict, Back
   --------------------------- */
function showPage(id){
  if(id === 'input'){ document.getElementById('pageInput').classList.add('active'); document.getElementById('pageInput').setAttribute('aria-hidden','false'); document.getElementById('pageOutput').classList.remove('active'); document.getElementById('pageOutput').setAttribute('aria-hidden','true'); }
  else { document.getElementById('pageOutput').classList.add('active'); document.getElementById('pageOutput').setAttribute('aria-hidden','false'); document.getElementById('pageInput').classList.remove('active'); document.getElementById('pageInput').setAttribute('aria-hidden','true'); }
}

document.getElementById('predictBtn').addEventListener('click', ()=>{
  // collect form
  const soil = document.getElementById('soil').value;
  const sowNowVal = document.querySelector('input[name="sowNow"]:checked').value;
  const sown = document.getElementById('sown').value;
  const soil_ph = parseFloat(document.getElementById('soil_ph').value);
  const tempRaw = parseFloat(document.getElementById('temp').value);
  const humidityRaw = parseFloat(document.getElementById('humidity').value);
  const nitrogen = parseFloat(document.getElementById('nitrogen').value);
  const phosphorus = parseFloat(document.getElementById('phosphorus').value);
  const potassium = parseFloat(document.getElementById('potassium').value);
  // basic validation
  if(!soil || !Number.isFinite(soil_ph) || !Number.isFinite(nitrogen) || !Number.isFinite(phosphorus) || !Number.isFinite(potassium)){
    alert(currentLang==='hi' ? 'कृपया सभी आवश्यक फ़ील्ड भरें' : 'Please fill required fields'); return;
  }
  if(sowNowVal === 'now'){
    if(!sown || !Number.isFinite(tempRaw) || !Number.isFinite(humidityRaw)){ alert(currentLang==='hi' ? 'कृपया मौसम, तापमान और आर्द्रता भरें' : 'Please fill season, temp and humidity'); return; }
  }
  const formData = {
    soil, sown: sowNowVal==='now' ? sown : null, soil_ph, temp: sowNowVal==='now' ? tempRaw : NaN, humidity: sowNowVal==='now' ? (Number.isFinite(humidityRaw) ? humidityRaw : NaN) : NaN,
    nitrogen: Number.isFinite(nitrogen)?nitrogen:NaN, phosphorus: Number.isFinite(phosphorus)?phosphorus:NaN, potassium: Number.isFinite(potassium)?potassium:NaN, sowNow: sowNowVal==='now'
  };
  // compute predictions
  const preds = simulateMLPrediction(formData);
  // store last form/preds
  window._lastForm = formData; window._lastPredictions = preds;
  // collapse any expanded panels when moving from input to output (requirement 5)
  showPage('output');
  // render output
  renderOutput(preds, formData);
  // scroll top
  window.scrollTo({top:0,behavior:'smooth'});
});

document.getElementById('backBtn').addEventListener('click', ()=>{
  // when going back, collapse panels and let user edit - requirement collapse & update
  showPage('input');
  // reset any expansions in crop list (they will be re-rendered next time)
  const cropList = document.getElementById('cropList'); cropList.innerHTML = '';
  // restore form values if present
  if(window._lastForm){
    try{
      const f = window._lastForm;
      if(f.soil) document.getElementById('soil').value = f.soil;
      if(f.sown) document.getElementById('sown').value = f.sown;
      if(Number.isFinite(f.soil_ph)) document.getElementById('soil_ph').value = f.soil_ph;
      if(Number.isFinite(f.temp)) document.getElementById('temp').value = f.temp;
      if(Number.isFinite(f.humidity)) document.getElementById('humidity').value = f.humidity;
      if(Number.isFinite(f.nitrogen)) document.getElementById('nitrogen').value = f.nitrogen;
      if(Number.isFinite(f.phosphorus)) document.getElementById('phosphorus').value = f.phosphorus;
      if(Number.isFinite(f.potassium)) document.getElementById('potassium').value = f.potassium;
      if(f.sowNow === false) document.querySelector('input[name="sowNow"][value="later"]').checked = true;
      updateSowUI();
    }catch(e){}
  }
});

/* reset */
document.getElementById('resetBtn').addEventListener('click', ()=>{
  document.getElementById('mainForm').reset();
  updateSowUI();
});

/* Auto location (only active for Sow now) */
document.getElementById('useLocationBtn').addEventListener('click', async function(){
  if(this.disabled) return;
  const orig = this.innerHTML; this.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${t('locRequesting')}`; this.disabled = true;
  try{
    if(!('geolocation' in navigator)){ alert(currentLang==='hi'?'ब्राउज़र में लोकेशन न उपलब्ध':'Geolocation not available'); return; }
    const pos = await new Promise((res,rej)=> navigator.geolocation.getCurrentPosition(res,rej,{timeout:12000}));
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&hourly=relativehumidity_2m&timezone=auto`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('weather fetch fail');
    const data = await r.json();
    const tempVal = typeof data.current_weather?.temperature === 'number' ? data.current_weather.temperature : null;
    let hum = null;
    if(data.hourly && Array.isArray(data.hourly.relativehumidity_2m) && Array.isArray(data.hourly.time)){
      const cur = data.current_weather?.time ?? null;
      if(cur){ const idx = data.hourly.time.indexOf(cur); if(idx>=0 && typeof data.hourly.relativehumidity_2m[idx]==='number') hum = data.hourly.relativehumidity_2m[idx]; }
      if(hum===null && data.hourly.relativehumidity_2m.length>0) hum = data.hourly.relativehumidity_2m[0];
    } else if(typeof data.relativehumidity_2m === 'number') hum = data.relativehumidity_2m;
    if(typeof tempVal === 'number') document.getElementById('temp').value = Math.round(tempVal*100)/100;
    if(typeof hum === 'number') document.getElementById('humidity').value = Math.round(hum*100)/100;
    // derive season from date
    const m = (new Date()).getMonth()+1;
    let season = 'rabi'; if(m>=6 && m<=10) season='kharif'; else if(m>=3 && m<=5) season='zaid';
    document.getElementById('sown').value = season;
    alert(currentLang==='hi'?'स्थान मिला — मौसम भरा गया':'Location found — weather filled');
  }catch(err){
    console.error(err); alert(currentLang==='hi'?'मौसम नहीं मिला — मैन्युअल दर्ज करें':'Unable to fetch weather — please fill manually');
  }finally{ this.innerHTML = orig; this.disabled = false; }
});

/* On load: restore values if present */
document.addEventListener('DOMContentLoaded', ()=>{
  if(window._lastForm && Object.keys(window._lastForm).length){
    try{
      const f = window._lastForm;
      if(f.soil) document.getElementById('soil').value = f.soil;
      if(f.sown) document.getElementById('sown').value = f.sown;
      if(Number.isFinite(f.soil_ph)) document.getElementById('soil_ph').value = f.soil_ph;
      if(Number.isFinite(f.temp)) document.getElementById('temp').value = f.temp;
      if(Number.isFinite(f.humidity)) document.getElementById('humidity').value = f.humidity;
      if(Number.isFinite(f.nitrogen)) document.getElementById('nitrogen').value = f.nitrogen;
      if(Number.isFinite(f.phosphorus)) document.getElementById('phosphorus').value = f.phosphorus;
      if(Number.isFinite(f.potassium)) document.getElementById('potassium').value = f.potassium;
      if(f.sowNow === false) document.querySelector('input[name="sowNow"][value="later"]').checked = true;
      updateSowUI();
    }catch(e){}
  }
});
</script>
</body>
</html>
