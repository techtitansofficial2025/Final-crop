<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡§ï‡§ø‡§∏‡§æ‡§® ‡§Æ‡§ø‡§§‡•ç‡§∞ - Crop Predictor | ‡§ï‡•É‡§∑‡§ø ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* (original CSS preserved exactly as provided by you, with only unused NPK/clock classes left harmless) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .language-toggle {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .language-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .input-section {
            padding: 40px;
            background: linear-gradient(145deg, #f8f9ff, #e8ecff);
            border-right: 1px solid #e0e0e0;
        }

        .output-section {
            padding: 40px;
            background: linear-gradient(145deg, #fff8f0, #f0f8ff);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1rem;
        }

        .bilingual {
            color: #666;
            font-size: 0.9rem;
            font-weight: normal;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .predict-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .predict-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }

        .predict-btn:active {
            transform: translateY(0);
        }
        .location-btn {
            display: inline-flex;
            align-items: center;
  gap: 8px;
  padding: 8px 12px;
  font-size: 0.95rem;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  background: linear-gradient(45deg, #43a047, #388e3c);
  color: white;
  box-shadow: 0 6px 12px rgba(0,0,0,0.08);
  transition: transform 0.18s ease, box-shadow 0.18s ease;
}
.location-btn:active { transform: translateY(1px); }
.location-btn[disabled] { opacity: 0.65; cursor: not-allowed; transform: none; }


        .results-container {
            text-align: center;
            width: 100%;
        }

        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #4CAF50;
            animation: slideIn 0.5s ease;
        }

        .result-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .result-subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        .empty-state {
            opacity: 0.7;
        }

        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state p {
            color: #999;
            font-size: 1.1rem;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-card {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .input-section, .output-section {
                padding: 25px;
            }

            .language-toggle {
                position: static;
                margin-bottom: 20px;
                display: inline-flex;
            }
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            color: #667eea;
            cursor: help;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }

        /* small helpers */
        .gauge-wrapper { display: none; } /* kept hidden, we are not using the analog gauge anymore */
        .probability-card {
            margin-top: 10px;
        }

        /* NPK related classes left but no longer used in markup */
        .npk-gauges { display: none; }

        .input-summary {
            text-align: left;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            white-space: pre-line;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="language-toggle" id="languageToggle" role="button" aria-pressed="false" tabindex="0">
                <i class="fas fa-language" aria-hidden="true"></i>
                <span id="langText">‡§π‡§ø‡§Ç‡§¶‡•Ä</span>
            </div>
            <h1><i class="fas fa-seedling"></i> <span id="mainTitle">‡§ï‡§ø‡§∏‡§æ‡§® ‡§Æ‡§ø‡§§‡•ç‡§∞ - Crop Predictor</span></h1>
            <p id="subtitle">‡§Ü‡§™‡§ï‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞</p>
        </div>

        <div class="main-card">
            <div class="input-section">
                <h2 style="margin-bottom: 25px; color: #333; text-align: center;">
                    <i class="fas fa-edit"></i> <span id="formTitle">‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§Ç</span>
                </h2>
            <!-- Use my location button -->
<div style="text-align:center; margin-bottom: 18px;">
  <button type="button" id="useLocationBtn" class="location-btn" title="Auto-fill temperature, humidity and season from your location">
    <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
    <span id="useLocationBtnText">Use my location</span>
  </button>
</div>

                
                <form id="cropForm">
                    <div class="form-group">
                        <label for="soil" id="soilLabel">
                            ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞
                            <i class="fas fa-info-circle info-tooltip">
                                <span class="tooltip-text" id="soilTooltip">‡§Ö‡§™‡§®‡•á ‡§ñ‡•á‡§§ ‡§ï‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç</span>
                            </i>
                        </label>
                        <select class="form-control" id="soil" required aria-required="true">
                            <option value="" id="soilPlaceholder" disabled selected>‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                            <!-- Long list kept as fallback; can be replaced by backend options -->
                            <option value="alluvial">‡§ú‡§≤‡•ã‡§¢‡§º ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Alluvial Soil</option>
                            <option value="loamy">‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Loamy Soil</option>
                            <option value="clay">‡§ö‡§ø‡§ï‡§®‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Clay Soil</option>
                            <option value="well-drained">‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§ú‡§≤ ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§µ‡§æ‡§≤‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Well-drained Soil</option>
                            <option value="red">‡§≤‡§æ‡§≤ ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Red Soil</option>
                            <option value="clay-loamy">‡§ö‡§ø‡§ï‡§®‡•Ä ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Clay Loamy Soil</option>
                            <option value="sandy-loamy">‡§∞‡•á‡§§‡•Ä‡§≤‡•Ä ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Sandy Loamy Soil</option>
                            <option value="black">‡§ï‡§æ‡§≤‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Black Soil</option>
                            <option value="sandy">‡§∞‡•á‡§§‡•Ä‡§≤‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Sandy Soil</option>
                            <option value="shallow-black">‡§â‡§•‡§≤‡•Ä ‡§ï‡§æ‡§≤‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Shallow Black Soil</option>
                            <option value="black-cotton">‡§ï‡§æ‡§≤‡•Ä ‡§ï‡§™‡§æ‡§∏ ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Black Cotton Soil</option>
                            <option value="cotton">‡§ï‡§™‡§æ‡§∏ ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Cotton Soil</option>
                            <option value="medium-black">‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ï‡§æ‡§≤‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Medium Black Soil</option>
                            <option value="heavy-black">‡§≠‡§æ‡§∞‡•Ä ‡§ï‡§æ‡§≤‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Heavy Black Soil</option>
                            <option value="light">‡§π‡§≤‡•ç‡§ï‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Light Soil</option>
                            <option value="heavy">‡§≠‡§æ‡§∞‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Heavy Soil</option>
                            <option value="deep">‡§ó‡§π‡§∞‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Deep Soil</option>
                            <option value="sandy-clay-loamy">‡§∞‡•á‡§§‡•Ä‡§≤‡•Ä ‡§ö‡§ø‡§ï‡§®‡•Ä ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Sandy Clay Loamy Soil</option>
                            <option value="silty-loamy">‡§Æ‡•Å‡§≤‡§æ‡§Ø‡§Æ ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Silty Loamy Soil</option>
                            <option value="salty-clay-loamy">‡§®‡§Æ‡§ï‡•Ä‡§® ‡§ö‡§ø‡§ï‡§®‡•Ä ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Salty Clay Loamy Soil</option>
                            <option value="red-loamy">‡§≤‡§æ‡§≤ ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Red Loamy Soil</option>
                            <option value="brown-loamy">‡§≠‡•Ç‡§∞‡•Ä ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Brown Loamy Soil</option>
                            <option value="laterite">‡§≤‡•á‡§ü‡§∞‡§æ‡§á‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Laterite Soil</option>
                            <option value="well-drained-loamy">‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§ú‡§≤ ‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§µ‡§æ‡§≤‡•Ä ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Well-drained Loamy Soil</option>
                            <option value="light-loamy">‡§π‡§≤‡•ç‡§ï‡•Ä ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Light Loamy Soil</option>
                            <option value="friable">‡§≠‡•Å‡§∞‡§≠‡•Å‡§∞‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Friable Soil</option>
                            <option value="well-grained-deep-loamy-moist">‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§¶‡§æ‡§®‡•á‡§¶‡§æ‡§∞ ‡§ó‡§π‡§∞‡•Ä ‡§¶‡•ã‡§Æ‡§ü ‡§®‡§Æ ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Well-grained Deep Loamy Moist Soil</option>
                            <option value="red-lateritic-loamy">‡§≤‡§æ‡§≤ ‡§≤‡•á‡§ü‡§∞‡§æ‡§á‡§ü ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Red Lateritic Loamy Soil</option>
                            <option value="rich-red-loamy">‡§∏‡§Æ‡•É‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≤ ‡§¶‡•ã‡§Æ‡§ü ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä | Rich Red Loamy Soil</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sown" id="seasonLabel">
                            ‡§¨‡•Å‡§µ‡§æ‡§à ‡§ï‡§æ ‡§Æ‡•å‡§∏‡§Æ
                            <i class="fas fa-info-circle info-tooltip">
                                <span class="tooltip-text" id="seasonTooltip">‡§Ü‡§™ ‡§ï‡§¨ ‡§¨‡•Å‡§µ‡§æ‡§à ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?</span>
                            </i>
                        </label>
                        <select class="form-control" id="sown" required aria-required="true">
                            <option value="" id="seasonPlaceholder" disabled selected>‡§Æ‡•å‡§∏‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç</option>
                            <option value="kharif">‡§ñ‡§∞‡•Ä‡§´ | Kharif (‡§Æ‡§æ‡§®‡§∏‡•Ç‡§®)</option>
                            <option value="rabi">‡§∞‡§¨‡•Ä | Rabi (‡§∏‡§∞‡•ç‡§¶‡•Ä)</option>
                            <option value="zaid">‡§ú‡§æ‡§Ø‡§¶ | Zaid (‡§ó‡§∞‡•ç‡§Æ‡•Ä)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="soil_ph" id="phLabel">
                            ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡§æ pH
                            <span class="bilingual"></span>
                        </label>
                        <!-- removed min/max to allow any float; step="any" allows floats -->
                        <input type="number" class="form-control" id="soil_ph" step="any" placeholder="e.g-7.0" required aria-required="true">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="temp" id="tempLabel">
                                ‡§§‡§æ‡§™‡§Æ‡§æ‡§®
                                <span class="bilingual">(¬∞C)</span>
                            </label>
                            <input type="number" class="form-control" id="temp" step="any" placeholder="e.g-25" required>
                        </div>
                        <div class="form-group">
                            <label for="humidity" id="humidityLabel">
                                ‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ
                                <span class="bilingual">(%)</span>
                            </label>
                            <input type="number" class="form-control" id="humidity" step="any" placeholder="e.g-60" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="nitrogen" id="nitrogenLabel">
                                ‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® (N)
                                <span class="bilingual">(kg/ha)</span>
                            </label>
                            <input type="number" class="form-control" id="nitrogen" step="any" placeholder="e.g-50" required>
                        </div>
                        <div class="form-group">
                            <label for="phosphorus" id="phosphorusLabel">
                                ‡§´‡§æ‡§∏‡•ç‡§´‡•ã‡§∞‡§∏ (P)
                                <span class="bilingual">(kg/ha)</span>
                            </label>
                            <input type="number" class="form-control" id="phosphorus" step="any" placeholder="e.g-25" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="potassium" id="potassiumLabel">
                            ‡§™‡•ã‡§ü‡•à‡§∂‡§ø‡§Ø‡§Æ (K)
                            <span class="bilingual">(kg/ha)</span>
                        </label>
                        <input type="number" class="form-control" id="potassium" step="any" placeholder="e.g-30" required>
                    </div>

                    <button type="submit" id="predictBtnEl" class="predict-btn">
                        <i class="fas fa-magic"></i> <span id="predictBtn">‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡•á‡§Ç</span>
                    </button>
                </form>
            </div>

            <div class="output-section">
                <!-- Removed semicircular analog meter (clock) per request -->
                <div id="resultsContainer" class="results-container">
                    <div class="empty-state">
                        <i class="fas fa-seedling" aria-hidden="true"></i>
                        <p id="emptyStateText">‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç<br><span class="bilingual">Please fill the details to get crop predictions</span></p>
                    </div>
                </div>

                <div id="loadingState" class="loading" aria-hidden="true">
                    <div class="spinner" role="status" aria-label="loading"></div>
                    <p id="loadingText">‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...<br><span class="bilingual">Analyzing your data...</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Language system (unchanged)
        let currentLang = 'hi';
        
        const translations = {
            hi: {
                langText: "English",
                mainTitle: "‡§ï‡§ø‡§∏‡§æ‡§® ‡§Æ‡§ø‡§§‡•ç‡§∞ - Crop Predictor",
                subtitle: "‡§Ü‡§™‡§ï‡•Ä ‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡§æ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞",
                formTitle: "‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§¶‡•á‡§Ç",
                soilLabel: "‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞",
                soilTooltip: "‡§Ö‡§™‡§®‡•á ‡§ñ‡•á‡§§ ‡§ï‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç",
                soilPlaceholder: "‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ö‡•Å‡§®‡•á‡§Ç",
                seasonLabel: "‡§¨‡•Å‡§µ‡§æ‡§à ‡§ï‡§æ ‡§Æ‡•å‡§∏‡§Æ",
                seasonTooltip: "‡§Ü‡§™ ‡§ï‡§¨ ‡§¨‡•Å‡§µ‡§æ‡§à ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?",
                seasonPlaceholder: "‡§Æ‡•å‡§∏‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç",
                phLabel: "‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡§æ pH",
                tempLabel: "‡§§‡§æ‡§™‡§Æ‡§æ‡§®",
                humidityLabel: "‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§§‡§æ",
                nitrogenLabel: "‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® (N)",
                phosphorusLabel: "‡§´‡§æ‡§∏‡•ç‡§´‡•ã‡§∞‡§∏ (P)",
                potassiumLabel: "‡§™‡•ã‡§ü‡•à‡§∂‡§ø‡§Ø‡§Æ (K)",
                predictBtn: "‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§ï‡§∞‡•á‡§Ç",
                emptyStateText: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡§∞‡•á‡§Ç<br><span class=\"bilingual\">Please fill the details to get crop predictions</span>",
                loadingText: "‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...<br><span class=\"bilingual\">Analyzing your data...</span>",
                recommendedCrop: "‡§∏‡•Å‡§ù‡§æ‡§µ‡§ø‡§§ ‡§´‡§∏‡§≤",
                waterSource: "‡§™‡§æ‡§®‡•Ä ‡§ï‡§æ ‡§∏‡•ç‡§∞‡•ã‡§§",
                cropDuration: "‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§Ö‡§µ‡§ß‡§ø",
                waterRequired: "‡§™‡§æ‡§®‡•Ä ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ",
                bestSuited: "‡§Ü‡§™‡§ï‡•Ä ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡•á ‡§Ö‡§®‡•Å‡§ï‡•Ç‡§≤",
                optimalIrrigation: "‡§¨‡•á‡§π‡§§‡§∞ ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à ‡§ï‡•á ‡§≤‡§ø‡§è",
                sowingToHarvest: "‡§¨‡•Å‡§µ‡§æ‡§à ‡§∏‡•á ‡§ï‡§ü‡§æ‡§à ‡§§‡§ï",
                perKgProduction: "‡§™‡•ç‡§∞‡§§‡§ø ‡§ï‡§ø‡§≤‡•ã ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§®",
                probabilitySection: "Probability of Growing",
                inputSummary: "Input Summary"
            },
            en: {
                langText: "‡§π‡§ø‡§Ç‡§¶‡•Ä",
                mainTitle: "Farmer Friend - Crop Predictor",
                subtitle: "Your Smart Agricultural Advisor for Crop Prediction",
                formTitle: "Enter Crop Details",
                soilLabel: "Soil Type",
                soilTooltip: "Select the type of soil in your field",
                soilPlaceholder: "Select Soil",
                seasonLabel: "Sowing Season",
                seasonTooltip: "When are you planning to sow?",
                seasonPlaceholder: "Select Season",
                phLabel: "Soil pH",
                tempLabel: "Temperature",
                humidityLabel: "Humidity",
                nitrogenLabel: "Nitrogen (N)",
                phosphorusLabel: "Phosphorus (P)",
                potassiumLabel: "Potassium (K)",
                predictBtn: "Predict Crop",
                emptyStateText: "Please fill the details to get crop predictions",
                loadingText: "Analyzing your data...",
                recommendedCrop: "Recommended Crop",
                waterSource: "Water Source",
                cropDuration: "Crop Duration",
                waterRequired: "Water Required",
                bestSuited: "Best suited for your soil",
                optimalIrrigation: "For optimal irrigation",
                sowingToHarvest: "From sowing to harvest",
                perKgProduction: "Per kg of production",
                probabilitySection: "Probability of Growing",
                inputSummary: "Input Summary"
            }
        };

        function updateLanguage() {
            const lang = currentLang;

            document.getElementById('langText').textContent = translations[lang].langText;
            document.getElementById('mainTitle').textContent = translations[lang].mainTitle;
            document.getElementById('subtitle').textContent = translations[lang].subtitle;
            document.getElementById('formTitle').textContent = translations[lang].formTitle;

            // Update labels & tooltips
            document.getElementById('soilLabel').innerHTML = translations[lang].soilLabel + `\n                <i class="fas fa-info-circle info-tooltip">\n                    <span class="tooltip-text">${translations[lang].soilTooltip}</span>\n                </i>`;

            const soilPlaceholder = document.getElementById('soilPlaceholder');
            if (soilPlaceholder) soilPlaceholder.textContent = translations[lang].soilPlaceholder;

            document.getElementById('seasonLabel').innerHTML = translations[lang].seasonLabel + `\n                <i class="fas fa-info-circle info-tooltip">\n                    <span class="tooltip-text">${translations[lang].seasonTooltip}</span>\n                </i>`;

            const seasonPlaceholder = document.getElementById('seasonPlaceholder');
            if (seasonPlaceholder) seasonPlaceholder.textContent = translations[lang].seasonPlaceholder;

            document.getElementById('phLabel').innerHTML = translations[lang].phLabel + '<span class="bilingual"></span>';
            document.getElementById('tempLabel').innerHTML = translations[lang].tempLabel + '<span class="bilingual">(¬∞C)</span>';
            document.getElementById('humidityLabel').innerHTML = translations[lang].humidityLabel + '<span class="bilingual">(%)</span>';
            document.getElementById('nitrogenLabel').innerHTML = translations[lang].nitrogenLabel + '<span class="bilingual">(kg/ha)</span>';
            document.getElementById('phosphorusLabel').innerHTML = translations[lang].phosphorusLabel + '<span class="bilingual">(kg/ha)</span>';
            document.getElementById('potassiumLabel').innerHTML = translations[lang].potassiumLabel + '<span class="bilingual">(kg/ha)</span>';

            document.getElementById('predictBtn').textContent = translations[lang].predictBtn;
            document.getElementById('emptyStateText').innerHTML = translations[lang].emptyStateText;
            document.getElementById('loadingText').innerHTML = translations[lang].loadingText;
        }

        document.getElementById('languageToggle').addEventListener('click', function() {
            currentLang = currentLang === 'hi' ? 'en' : 'hi';
            this.setAttribute('aria-pressed', currentLang === 'en');
            updateLanguage();
        });

        // Sample data and simulateMLPrediction left unchanged for crop suggestions
        const cropDatabase = {
            'alluvial_kharif_high_ph': {
                crop: 'üåæ ‡§ß‡§æ‡§® | Rice',
                water_source: 'üèûÔ∏è ‡§®‡§¶‡•Ä | River',
                duration: '‚è∞ 120 ‡§¶‡§ø‡§® | 120 days',
                water_required: 'üíß 1200 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 1200 L/kg'
            },
            'loamy_rabi_neutral_ph': {
                crop: 'üåæ ‡§ó‡•á‡§π‡•Ç‡§Ç | Wheat',
                water_source: 'üï≥Ô∏è ‡§ï‡•Å‡§Ü‡§Ç | Borewell',
                duration: '‚è∞ 110 ‡§¶‡§ø‡§® | 110 days',
                water_required: 'üíß 800 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 800 L/kg'
            },
            'sandy_zaid_neutral_ph': {
                crop: 'üåΩ ‡§Æ‡§ï‡•ç‡§ï‡§æ | Maize',
                water_source: 'üí¶ ‡§°‡•ç‡§∞‡§ø‡§™ ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à | Drip Irrigation',
                duration: '‚è∞ 95 ‡§¶‡§ø‡§® | 95 days',
                water_required: 'üíß 600 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 600 L/kg'
            },
            'black_kharif_high_ph': {
                crop: 'üå∏ ‡§ï‡§™‡§æ‡§∏ | Cotton',
                water_source: 'üåßÔ∏è ‡§¨‡§æ‡§∞‡§ø‡§∂ | Rainwater',
                duration: '‚è∞ 180 ‡§¶‡§ø‡§® | 180 days',
                water_required: 'üíß 1800 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 1800 L/kg'
            },
            'red_rabi_low_ph': {
                crop: 'ü´ò ‡§¶‡§æ‡§≤ | Pulses',
                water_source: 'üèä ‡§§‡§æ‡§≤‡§æ‡§¨ | Pond',
                duration: '‚è∞ 85 ‡§¶‡§ø‡§® | 85 days',
                water_required: 'üíß 400 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 400 L/kg'
            }
        };

        function getPredictionKey(soil, sown, ph) {
            let phCategory = ph < 6.5 ? 'low_ph' : ph > 7.5 ? 'high_ph' : 'neutral_ph';
            return `${soil}_${sown}_${phCategory}`;
        }

        function simulateMLPrediction(formData) {
            const key = getPredictionKey(formData.soil, formData.sown, formData.soil_ph);
            let prediction = cropDatabase[key];

            if (!prediction) {
                if (formData.sown === 'kharif') {
                    if (formData.soil.includes('black') || formData.soil.includes('cotton')) {
                        prediction = { crop: 'üå∏ ‡§ï‡§™‡§æ‡§∏ | Cotton', water_source: 'üåßÔ∏è ‡§¨‡§æ‡§∞‡§ø‡§∂ | Rainwater', duration: '‚è∞ 180 ‡§¶‡§ø‡§® | 180 days', water_required: 'üíß 1800 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 1800 L/kg' };
                    } else if (formData.soil.includes('alluvial') || formData.soil.includes('clay')) {
                        prediction = { crop: 'üåæ ‡§ß‡§æ‡§® | Rice', water_source: 'üèûÔ∏è ‡§®‡§¶‡•Ä | River', duration: '‚è∞ 120 ‡§¶‡§ø‡§® | 120 days', water_required: 'üíß 1200 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 1200 L/kg' };
                    } else if (formData.soil.includes('red')) {
                        prediction = { crop: 'üåΩ ‡§ú‡•ç‡§µ‡§æ‡§∞ | Sorghum', water_source: 'üåßÔ∏è ‡§¨‡§æ‡§∞‡§ø‡§∂ | Rainwater', duration: '‚è∞ 110 ‡§¶‡§ø‡§® | 110 days', water_required: 'üíß 650 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 650 L/kg' };
                    } else {
                        prediction = { crop: 'üåø ‡§¨‡§æ‡§ú‡§∞‡§æ | Pearl Millet', water_source: 'üåßÔ∏è ‡§¨‡§æ‡§∞‡§ø‡§∂ | Rainwater', duration: '‚è∞ 90 ‡§¶‡§ø‡§® | 90 days', water_required: 'üíß 500 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 500 L/kg' };
                    }
                } else if (formData.sown === 'rabi') {
                    if (formData.soil.includes('loamy') || formData.soil.includes('alluvial')) {
                        prediction = { crop: 'üåæ ‡§ó‡•á‡§π‡•Ç‡§Ç | Wheat', water_source: 'üï≥Ô∏è ‡§ï‡•Å‡§Ü‡§Ç | Borewell', duration: '‚è∞ 110 ‡§¶‡§ø‡§® | 110 days', water_required: 'üíß 800 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 800 L/kg' };
                    } else if (formData.soil.includes('red') || formData.soil.includes('laterite')) {
                        prediction = { crop: 'ü´ò ‡§¶‡§æ‡§≤ | Pulses', water_source: 'üèä ‡§§‡§æ‡§≤‡§æ‡§¨ | Pond', duration: '‚è∞ 85 ‡§¶‡§ø‡§® | 85 days', water_required: 'üíß 400 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 400 L/kg' };
                    } else if (formData.soil.includes('black')) {
                        prediction = { crop: 'üå∞ ‡§ö‡§®‡§æ | Chickpea', water_source: 'üí¶ ‡§°‡•ç‡§∞‡§ø‡§™ ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à | Drip Irrigation', duration: '‚è∞ 100 ‡§¶‡§ø‡§® | 100 days', water_required: 'üíß 350 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 350 L/kg' };
                    } else {
                        prediction = { crop: 'üåæ ‡§ú‡•å | Barley', water_source: 'üí¶ ‡§°‡•ç‡§∞‡§ø‡§™ ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à | Drip Irrigation', duration: '‚è∞ 95 ‡§¶‡§ø‡§® | 95 days', water_required: 'üíß 550 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 550 L/kg' };
                    }
                } else { // zaid
                    if (formData.soil.includes('sandy')) {
                        prediction = { crop: 'üåΩ ‡§Æ‡§ï‡•ç‡§ï‡§æ | Maize', water_source: 'üí¶ ‡§°‡•ç‡§∞‡§ø‡§™ ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à | Drip Irrigation', duration: '‚è∞ 95 ‡§¶‡§ø‡§® | 95 days', water_required: 'üíß 600 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 600 L/kg' };
                    } else if (formData.soil.includes('loamy')) {
                        prediction = { crop: 'ü•î ‡§Ü‡§≤‡•Ç | Potato', water_source: 'üö∞ ‡§ü‡•ç‡§Ø‡•Ç‡§¨‡§µ‡•á‡§≤ | Tubewell', duration: '‚è∞ 90 ‡§¶‡§ø‡§® | 90 days', water_required: 'üíß 500 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 500 L/kg' };
                    } else if (formData.soil.includes('well-drained')) {
                        prediction = { crop: 'üåª ‡§∏‡•Ç‡§∞‡§ú‡§Æ‡•Å‡§ñ‡•Ä | Sunflower', water_source: 'üíß ‡§∏‡•ç‡§™‡•ç‡§∞‡§ø‡§Ç‡§ï‡§≤‡§∞ | Sprinkler', duration: '‚è∞ 100 ‡§¶‡§ø‡§® | 100 days', water_required: 'üíß 700 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 700 L/kg' };
                    } else {
                        prediction = { crop: 'ü•í ‡§ñ‡•Ä‡§∞‡§æ | Cucumber', water_source: 'üí¶ ‡§°‡•ç‡§∞‡§ø‡§™ ‡§∏‡§ø‡§Ç‡§ö‡§æ‡§à | Drip Irrigation', duration: '‚è∞ 60 ‡§¶‡§ø‡§® | 60 days', water_required: 'üíß 400 ‡§≤‡•Ä‡§ü‡§∞/‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ | 400 L/kg' };
                    }
                }
            }

            return prediction;
        }

        // ===== Backend config & helper =====
        const API_CONFIG = {
            baseURL: 'https://crop-sage-uj67.onrender.com',
            endpoints: {
                soilTypes: '/api/soil-types',
                weatherData: '/api/weather',
                cropPrediction: '/api/predict-crop',
                userLocation: '/api/location',
                health: '/health'
            }
        };

        class BackendAPI {
            static async makeRequest(endpoint, options = {}) {
                const url = `${API_CONFIG.baseURL}${endpoint}`;
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };

                try {
                    const response = await fetch(url, { ...defaultOptions, ...options });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const text = await response.text();
                    const data = text ? JSON.parse(text) : {};
                    return { success: true, data };
                } catch (error) {
                    console.error('API Error:', error);
                    return { success: false, error: error.message };
                }
            }

            static async checkHealth() {
                return await this.makeRequest(API_CONFIG.endpoints.health);
            }

            static async getSoilTypes() {
                return await this.makeRequest(API_CONFIG.endpoints.soilTypes);
            }

            // ===== UPDATED: call Open-Meteo directly and sanitize humidity =====
            static async getWeather(lat, lon) {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&current_weather=true&hourly=relativehumidity_2m&timezone=auto`;

                try {
                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    const data = await resp.json();

                    const temp = typeof data.current_weather?.temperature === 'number' ? data.current_weather.temperature : null;

                    let humidity = null;
                    if (data.hourly && Array.isArray(data.hourly.relativehumidity_2m) && Array.isArray(data.hourly.time)) {
                        const currentTime = data.current_weather?.time ?? null;
                        if (currentTime) {
                            const idx = data.hourly.time.indexOf(currentTime);
                            if (idx >= 0 && typeof data.hourly.relativehumidity_2m[idx] === 'number') {
                                humidity = data.hourly.relativehumidity_2m[idx];
                            }
                        }
                        if (humidity === null && data.hourly.relativehumidity_2m.length > 0) {
                            humidity = data.hourly.relativehumidity_2m[0];
                        }
                    } else if (typeof data.relativehumidity_2m === 'number') {
                        humidity = data.relativehumidity_2m;
                    }

                    // Sanitize humidity: only accept 0..100
                    if (typeof humidity !== 'number' || !isFinite(humidity) || humidity < 0 || humidity > 100) {
                        humidity = null;
                    }

                    return { success: true, data: { temp: temp ?? null, humidity: humidity ?? null, raw: data } };
                } catch (err) {
                    console.error('Open-Meteo error:', err);
                    return { success: false, error: err.message || String(err) };
                }
            }

            static async predictCrop(formData) {
                return await this.makeRequest(API_CONFIG.endpoints.cropPrediction, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
            }
        }

        // ===== UI helpers =====
        function setLoading(isLoading) {
            const results = document.getElementById('resultsContainer');
            const loading = document.getElementById('loadingState');
            const submitBtn = document.getElementById('predictBtnEl');

            if (isLoading) {
                results.style.display = 'none';
                loading.style.display = 'block';
                loading.setAttribute('aria-hidden', 'false');
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.7';
                submitBtn.style.cursor = 'not-allowed';
            } else {
                loading.style.display = 'none';
                loading.setAttribute('aria-hidden', 'true');
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                results.style.display = 'block';
            }
        }

        // Build textual input summary & NPK textual status instead of gauges
        function inputStatusText(formData, predictedCrop) {
            // helper: for NPK decide Low / Near ideal / High relative to ideal ranges
            function getIdealNPK(cropName) {
                const name = (cropName || '').toLowerCase();
                const defaultRange = { N: {min: 20, max: 80}, P: {min: 10, max: 40}, K: {min: 20, max: 80} };
                const map = [
                    { keywords: ['rice', '‡§ß‡§æ‡§®'], ranges: { N: {min: 60, max: 140}, P: {min: 20, max: 60}, K: {min: 40, max: 120} } },
                    { keywords: ['wheat', '‡§ó‡•á‡§π‡•Ç‡§Å', '‡§ó‡•á‡§π‡•Ç'], ranges: { N: {min: 80, max: 160}, P: {min: 30, max: 70}, K: {min: 30, max: 80} } },
                    { keywords: ['maize', '‡§Æ‡§ï‡•ç‡§ï‡§æ', 'corn'], ranges: { N: {min: 80, max: 200}, P: {min: 30, max: 80}, K: {min: 40, max: 120} } },
                    { keywords: ['cotton', '‡§ï‡§™‡§æ‡§∏'], ranges: { N: {min: 60, max: 120}, P: {min: 30, max: 60}, K: {min: 40, max: 120} } },
                    { keywords: ['pulses', '‡§¶‡§æ‡§≤', 'lentil', 'chickpea', '‡§ö‡§®‡§æ'], ranges: { N: {min: 10, max: 40}, P: {min: 20, max: 50}, K: {min: 20, max: 60} } }
                ];
                for (const item of map) {
                    for (const kw of item.keywords) {
                        if (name.includes(kw)) return item.ranges;
                    }
                }
                return defaultRange;
            }

            function statusForNPK(value, idealRange) {
                if (!Number.isFinite(value)) return 'Not provided';
                if (value < idealRange.min) return 'Low';
                if (value > idealRange.max) return 'High';
                return 'Near ideal';
            }

            const ideal = getIdealNPK(predictedCrop || '');
            const nStatus = statusForNPK(formData.nitrogen, ideal.N);
            const pStatus = statusForNPK(formData.phosphorus, ideal.P);
            const kStatus = statusForNPK(formData.potassium, ideal.K);

            // pH, temp, humidity textual check
            function checkPH(v) {
                if (!Number.isFinite(v)) return 'Not provided';
                if (v < 4.5 || v > 9.0) return `Out of typical range (${v})`;
                if (v < 6.5) return `Acidic (${v})`;
                if (v > 7.5) return `Alkaline (${v})`;
                return `Neutral (${v})`;
            }
            function checkTemp(v) {
                if (!Number.isFinite(v)) return 'Not provided';
                if (v < -10 || v > 50) return `Out of typical range (${v}¬∞C)`;
                return `${v}¬∞C`;
            }
            function checkHumidity(v) {
                if (!Number.isFinite(v)) return 'Not provided';
                if (v < 0 || v > 100) return `Out of range (${v}%)`;
                if (v < 30) return `${v}% (Low)`;
                if (v <= 70) return `${v}% (Good)`;
                return `${v}% (High)`;
            }

            const phText = checkPH(formData.soil_ph);
            const tempText = checkTemp(formData.temp);
            const humText = checkHumidity(formData.humidity);

            // Compose a short multi-line textual summary (user requested format like "N: High\nP: Low\n...")
            const lines = [
                `N: ${nStatus}`,
                `P: ${pStatus}`,
                `K: ${kStatus}`,
                `pH: ${phText}`,
                `Temp: ${tempText}`,
                `Humidity: ${humText}`
            ];
            return lines.join('\n');
        }

        function displayResults(prediction, inputCompletenessScore = null, derivedProbability = null, npkValues = null) {
            const lang = currentLang;

            let html = `
                <div class="result-card">
                    <div class="result-title">
                        <i class="fas fa-seedling"></i>
                        ${translations[lang].recommendedCrop}
                    </div>
                    <div class="result-value">${prediction.crop}</div>
                    <div class="result-subtitle">${translations[lang].bestSuited}</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">
                        <i class="fas fa-tint"></i>
                        ${translations[lang].waterSource}
                    </div>
                    <div class="result-value">${prediction.water_source}</div>
                    <div class="result-subtitle">${translations[lang].optimalIrrigation}</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">
                        <i class="fas fa-calendar-alt"></i>
                        ${translations[lang].cropDuration}
                    </div>
                    <div class="result-value">${prediction.duration}</div>
                    <div class="result-subtitle">${translations[lang].sowingToHarvest}</div>
                </div>
                
                <div class="result-card">
                    <div class="result-title">
                        <i class="fas fa-water"></i>
                        ${translations[lang].waterRequired}
                    </div>
                    <div class="result-value">${prediction.water_required}</div>
                    <div class="result-subtitle">${translations[lang].perKgProduction}</div>
                </div>
            `;

            if (inputCompletenessScore === null) inputCompletenessScore = 0;

            // Use prediction.confidence if provided; else use derivedProbability
            const probabilityPercent = (typeof prediction.confidence === 'number') ? Math.round(prediction.confidence * 100) : (derivedProbability !== null ? Math.round(derivedProbability) : null);

            // Input Summary (textual) ‚Äî replaced visual gauge
            html += `
                <div class="result-card" style="border-left-color: #9C27B0;">
                    <div class="result-title">
                        <i class="fas fa-list"></i>
                        ${translations[lang].inputSummary || 'Input Summary'}
                    </div>
                    <div class="result-subtitle input-summary" id="inputSummaryText">Loading...</div>
                    <div style="margin-top:10px; color:#666; font-size:0.95rem;">Completeness: ${inputCompletenessScore}%</div>
                </div>
            `;

            // Probability of Growing section (now uses computed probabilityPercent)
            html += `
                <div class="result-card probability-card" style="border-left-color: #3F51B5;">
                    <div class="result-title">
                        <i class="fas fa-percentage"></i>
                        ${translations[lang].probabilitySection}
                    </div>
                    <div class="result-value" id="probValue">${probabilityPercent !== null ? probabilityPercent + '%' : '‚Äî'}</div>
                    <div class="result-subtitle" id="probSubtitle">${probabilityPercent !== null ? (probabilityPercent >= 70 ? 'High likelihood' : (probabilityPercent >= 40 ? 'Moderate likelihood' : 'Low likelihood')) : 'Probability not available'}</div>
                </div>
            `;

            // If prediction.confidence exists, show it explicitly
            if (typeof prediction.confidence === 'number') {
                html += `
                <div class="result-card" style="border-left-color: #2196F3;">
                    <div class="result-title">
                        <i class="fas fa-chart-line"></i>
                        Prediction Confidence
                    </div>
                    <div class="result-value">${Math.round(prediction.confidence * 100)}%</div>
                    <div class="result-subtitle">Model accuracy for this prediction</div>
                </div>
                `;
            }

            document.getElementById('resultsContainer').innerHTML = html;

            // Now fill the textual input summary (separately, after DOM inserted)
            const summary = inputStatusText({
                soil_ph: npkValues && typeof npkValues.soil_ph === 'number' ? npkValues.soil_ph : (window._lastFormData && window._lastFormData.soil_ph),
                temp: npkValues && typeof npkValues.temp === 'number' ? npkValues.temp : (window._lastFormData && window._lastFormData.temp),
                humidity: npkValues && typeof npkValues.humidity === 'number' ? npkValues.humidity : (window._lastFormData && window._lastFormData.humidity),
                nitrogen: npkValues && typeof npkValues.nitrogen === 'number' ? npkValues.nitrogen : (window._lastFormData && window._lastFormData.nitrogen),
                phosphorus: npkValues && typeof npkValues.phosphorus === 'number' ? npkValues.phosphorus : (window._lastFormData && window._lastFormData.phosphorus),
                potassium: npkValues && typeof npkValues.potassium === 'number' ? npkValues.potassium : (window._lastFormData && window._lastFormData.potassium)
            }, prediction.crop);

            const summaryEl = document.getElementById('inputSummaryText');
            if (summaryEl) summaryEl.textContent = summary;
        }

        // show notification & error helpers (unchanged)
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'warning' ? '#FF9800' : '#2196F3'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                transform: translateX(400px);
                transition: transform 0.3s ease;
                font-weight: 500;
                max-width: 300px;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);
        }

        function showErrorMessage(message) {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="result-card" style="border-left-color: #f44336;">
                    <div class="result-title" style="color: #f44336;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error
                    </div>
                    <div class="result-value" style="color: #f44336; font-size: 1.2rem;">${message}</div>
                    <div class="result-subtitle">Please check your connection and try again</div>
                </div>
            `;
        }

        // Load soil types from backend (if available)
        async function loadSoilTypes() {
            try {
                const soilResponse = await BackendAPI.getSoilTypes();
                if (soilResponse.success && Array.isArray(soilResponse.data) && soilResponse.data.length > 0) {
                    const soilSelect = document.getElementById('soil');
                    const placeholder = soilSelect.querySelector('#soilPlaceholder');

                    soilSelect.innerHTML = '';
                    soilSelect.appendChild(placeholder);

                    soilResponse.data.forEach(soil => {
                        const option = document.createElement('option');
                        option.value = soil.code || soil.id || (soil.name_en ? soil.name_en.toLowerCase().replace(/\s+/g, '-') : (soil.name || '').toLowerCase().replace(/\s+/g, '-'));
                        option.textContent = `${soil.name_hi || soil.name} | ${soil.name_en || soil.name}`;
                        soilSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load soil types from backend:', error);
            }
        }

        // ===== Updated: smarter, variable probability heuristic (no backend changes) =====
        function computeDerivedProbability(formData, completenessScore) {
            // completenessScore 0..100
            const base = 30; // base probability when minimal info
            // quality points: each reasonable condition adds up to 10 points
            let quality = 0;
            const temp = formData.temp;
            const humidity = formData.humidity;
            const ph = formData.soil_ph;

            if (Number.isFinite(temp) && temp >= -5 && temp <= 45) quality += 8;
            if (Number.isFinite(humidity) && humidity >= 10 && humidity <= 90) quality += 8;
            if (Number.isFinite(ph) && ph >= 5 && ph <= 8) quality += 8;

            // completeness contributes (scaled)
            const completenessContribution = Math.round(completenessScore * 0.55); // 0..55

            let prob = base + completenessContribution + quality; // 30..~100
            prob = Math.round(Math.min(95, prob)); // cap at 95 for safety
            return prob;
        }

        // Handle form submission & prediction
        async function handleFormSubmission(formData) {
            try {
                setLoading(true);

                const backendResponse = await BackendAPI.predictCrop({
                    ...formData,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    language: currentLang
                });

                let prediction;
                if (backendResponse.success && backendResponse.data && Object.keys(backendResponse.data).length > 0) {
                    prediction = backendResponse.data;
                } else {
                    prediction = simulateMLPrediction(formData);
                }

                // Compute input completeness score
                const numericFields = ['soil_ph', 'temp', 'humidity', 'nitrogen', 'phosphorus', 'potassium'];
                let filledCount = 0;
                numericFields.forEach(k => {
                    const v = formData[k];
                    if (typeof v === 'number' && Number.isFinite(v)) filledCount++;
                });
                const completenessScore = Math.round((filledCount / numericFields.length) * 100);

                // Derived probability: use backend confidence if available otherwise computed heuristic
                let derivedProb = null;
                if (typeof prediction.confidence === 'number') {
                    derivedProb = Math.round(prediction.confidence * 100);
                } else {
                    derivedProb = computeDerivedProbability(formData, completenessScore);
                }

                setLoading(false);

                // store last form data globally to allow summary rendering
                window._lastFormData = formData;

                displayResults(prediction, completenessScore, derivedProb, {
                    nitrogen: formData.nitrogen,
                    phosphorus: formData.phosphorus,
                    potassium: formData.potassium,
                    soil_ph: formData.soil_ph,
                    temp: formData.temp,
                    humidity: formData.humidity
                });
            } catch (error) {
                console.error('Prediction error:', error);
                setLoading(false);
                showErrorMessage('Unable to get prediction. Please try again.');
            }
        }

        // Wire form submit
        document.getElementById('cropForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const soil = document.getElementById('soil').value;
            const sown = document.getElementById('sown').value;
            const soil_ph = parseFloat(document.getElementById('soil_ph').value);
            const temp = parseFloat(document.getElementById('temp').value);
            const humidityRaw = parseFloat(document.getElementById('humidity').value);
            // sanitize humidity here as well: clamp 0..100, else treat as invalid
            const humidity = (Number.isFinite(humidityRaw) && humidityRaw >= 0 && humidityRaw <= 100) ? humidityRaw : NaN;

            const nitrogen = parseFloat(document.getElementById('nitrogen').value);
            const phosphorus = parseFloat(document.getElementById('phosphorus').value);
            const potassium = parseFloat(document.getElementById('potassium').value);

            if (!soil || !sown || isNaN(soil_ph) || isNaN(temp) || isNaN(humidity)) {
                showNotification('‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç / Please fill all required fields', 'warning');
                return;
            }

            const formData = { soil, sown, soil_ph, temp, humidity, nitrogen, phosphorus, potassium };
            await handleFormSubmission(formData);
        });

        // small input focus animation (unchanged)
        const inputs = document.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.style.transform = 'scale(1.02)';
            });
            input.addEventListener('blur', function() {
                this.style.transform = 'scale(1)';
            });
        });

        // ----------------- Auto-fill temp/humidity/season from system location (updated sanitize) -----------------
        function deriveSeasonFromDate(date = new Date()) {
            const month = date.getMonth() + 1;
            if (month >= 6 && month <= 10) return 'kharif';
            if (month >= 3 && month <= 5) return 'zaid';
            return 'rabi';
        }

        async function tryAutoFillFromLocation() {
            const tempEl = document.getElementById('temp');
            const humidityEl = document.getElementById('humidity');
            const sownEl = document.getElementById('sown');
            const useLocBtn = document.getElementById('useLocationBtn');

            function enableManualWeatherInputs() {
                tempEl.readOnly = false;
                humidityEl.readOnly = false;
                sownEl.disabled = false;
            }

            function lockWeatherInputs() {
                tempEl.readOnly = true;
                humidityEl.readOnly = true;
                sownEl.disabled = true;
            }

            if (!('geolocation' in navigator)) {
                showNotification('Geolocation not available ‚Äî please enter temperature, humidity and season manually', 'warning');
                enableManualWeatherInputs();
                return;
            }

            const geoOptions = { enableHighAccuracy: false, timeout: 12000, maximumAge: 60000 };
            const geoPromise = new Promise((resolve, reject) => {
                navigator.geolocation.getCurrentPosition(resolve, reject, geoOptions);
            });

            try {
                const pos = await geoPromise;
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                try {
                    const weatherResp = await BackendAPI.getWeather(lat, lon);
                    if (weatherResp.success && weatherResp.data) {
                        const data = weatherResp.data;
                        const tempVal = (typeof data.temp === 'number') ? data.temp : null;
                        const humidityVal = (typeof data.humidity === 'number') ? data.humidity : null;

                        const hasTemp = Number.isFinite(tempVal);
                        const hasHumidity = Number.isFinite(humidityVal);

                        if (hasTemp) {
                            tempEl.value = Math.round(tempVal * 100) / 100;
                        }
                        if (hasHumidity) {
                            // clamp and store
                            const h = Math.max(0, Math.min(100, Math.round(humidityVal * 100) / 100));
                            humidityEl.value = h;
                        }

                        const derivedSeason = deriveSeasonFromDate(new Date());
                        if (['kharif','rabi','zaid'].includes(derivedSeason)) {
                            sownEl.value = derivedSeason;
                        }

                        if (hasTemp || hasHumidity) {
                            if (hasTemp) tempEl.readOnly = true;
                            if (hasHumidity) humidityEl.readOnly = true;
                            sownEl.disabled = true;
                            showNotification('Location detected ‚Äî temperature, humidity and season auto-filled', 'success');
                        } else {
                            showNotification('Location found but weather unavailable ‚Äî please enter temperature and humidity manually', 'warning');
                            enableManualWeatherInputs();
                        }
                        return;
                    } else {
                        showNotification('Unable to fetch weather for your location ‚Äî please enter temperature, humidity and season manually', 'warning');
                        enableManualWeatherInputs();
                        return;
                    }
                } catch (err) {
                    console.error('Weather fetch error:', err);
                    showNotification('Error fetching weather ‚Äî please enter temperature, humidity and season manually', 'warning');
                    enableManualWeatherInputs();
                    return;
                }
            } catch (geoErr) {
                console.warn('Geolocation error or permission denied:', geoErr);
                showNotification('Location access denied ‚Äî please enter temperature, humidity and season manually', 'warning');
                enableManualWeatherInputs();
                return;
            }
        }

        // Initialize
        async function initializeApp() {
            updateLanguage();

            try {
                const healthCheck = await BackendAPI.checkHealth();
                if (healthCheck.success) {
                    showNotification('‚úÖ Connected to Crop Sage AI Backend!', 'success');
                    await loadSoilTypes();
                } else {
                    showNotification('‚ö†Ô∏è Backend offline - using local features', 'warning');
                }
            } catch (error) {
                console.error('Health check failed:', error);
                showNotification('üîÑ Working in offline mode', 'info');
            }

            const useLocBtn = document.getElementById('useLocationBtn');
            if (useLocBtn) {
              useLocBtn.addEventListener('click', async function() {
                useLocBtn.disabled = true;
                const origHtml = useLocBtn.innerHTML;
                useLocBtn.innerHTML = `<i class="fas fa-spinner fa-spin" aria-hidden="true"></i> Requesting...`;

                try {
                  await tryAutoFillFromLocation();
                } catch (err) {
                  console.error('Location button error:', err);
                  showNotification('Unable to complete location request', 'warning');
                } finally {
                  useLocBtn.disabled = false;
                  useLocBtn.innerHTML = origHtml;
                }
              });
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
